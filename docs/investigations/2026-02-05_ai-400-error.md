# Investigation: Superhuman AI 400 Errors

**Date**: 2026-02-05
**Issue**: [#8](https://github.com/edwinhu/superhuman-cli/issues/8) — superhuman ai failing with MS Graph 400
**Status**: Fixed

## Symptoms

- `superhuman ai <thread-id> "prompt"` fails with "MS Graph API error: 400 Bad Request"
- Error occurs for both Outlook and Gmail accounts (per original issue report)
- Other CLI commands (search, read, calendar) work normally

## Root Cause Analysis

**Two independent bugs, both contributing to the failure:**

### Bug 1: Wrong AI endpoint (primary)

The CLI used `/v3/ai.askAIProxy` which requires a specific `question_event_id` format. The backend returns:

```json
{"code":400,"detail":"invalid-question-event-id","message":"Something went wrong."}
```

The `generateEventId()` function attempted to reverse-engineer Superhuman's ID format but didn't produce valid IDs. Superhuman's own frontend uses a completely different endpoint: `/v3/ai.compose`.

**Evidence**: Inspecting Superhuman's minified `backend.aiCompose()` method via CDP revealed the native endpoint and payload format.

### Bug 2: MS Graph `$filter` on `conversationId` fails (secondary)

The `getThreadMessagesForAI()` function used:
```
/me/messages?$filter=conversationId eq '${threadId}'
```

MS Graph returns `InefficientFilter` error for `$filter` on `conversationId` at the `/me/messages` level. This filter only works when scoped to a specific folder (e.g., `/me/mailFolders/Inbox/messages`).

**Evidence**: Direct API testing confirmed:
- `/me/messages?$filter=conversationId eq '...'` → 400 InefficientFilter
- `/me/mailFolders/Inbox/messages?$filter=conversationId eq '...'` → 200 OK
- `/me/messages?$top=50` + client-side filter → 200 OK

### Why the issue report was misleading

The original issue said "MS Graph API error: 400 Bad Request" for Gmail too. This was actually because:
1. For the Gmail path, the thread ID from Superhuman's internal cache was invalid (method names like `replacedIds` from `Object.keys(ga.threadStore)`)
2. The real Gmail error was "Invalid id value" (not MS Graph related)
3. When using valid Gmail thread IDs, the Gmail path worked fine for message fetching — but then failed at the `askAIProxy` endpoint (Bug 1)

## Fix

### Change 1: Switch to `ai.compose` endpoint

Replaced `askAI()` to use `/v3/ai.compose` (Superhuman's native endpoint):
- No `question_event_id` required
- Takes `thread_content` as a string (provider-agnostic)
- Takes `instructions` instead of `query`
- Returns SSE stream with `choices[0].delta.content` format

### Change 2: Fix MS Graph message fetching

Replaced `$filter` approach with client-side filtering:
- Fetch recent messages from `/me/messages?$top=50`
- Filter by `conversationId` client-side
- Fall back to direct message fetch by ID

## Remaining Issues

4 other locations in `token-api.ts` use the same broken `$filter=conversationId eq` pattern:
- `getThreadDirect()` (line ~1023) — attachments
- Line ~1177 — draft creation
- `getThreadInfoDirect()` (line ~2109) — reply headers
- Line ~2397 — send flow

These should be fixed in a follow-up to prevent 400 errors in other MS Graph commands.

## Testing

Verified fix works on all 3 accounts:
- `eddyhu@gmail.com` (Gmail) — SUCCESS
- `ehu@law.virginia.edu` (MS Graph/Outlook) — SUCCESS
- `eh2889@nyu.edu` (Gmail) — SUCCESS

Pre-existing test failures (30 pass / 27 fail) unchanged by this fix.
